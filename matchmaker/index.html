<!DOCTYPE html>
<html>
<head>
	<title>MatchMaker</title>
	<!-- <link rel="stylesheet" type="text/css" href="css/style.css"> -->
	<link rel="preconnect" href="https://cdn.fonts.net/kit/b0386608-2665-4bdb-9fbd-a444e77360a7/b0386608-2665-4bdb-9fbd-a444e77360a7_enhanced.js" crossorigin>
	<script type="text/javascript" src="https://cdn.fonts.net/kit/b0386608-2665-4bdb-9fbd-a444e77360a7/b0386608-2665-4bdb-9fbd-a444e77360a7_enhanced.js" async></script>
	
	<link rel="stylesheet" type="text/css" href="css/etc.min.css">
	<link rel="stylesheet" type="text/css" href="css/ext.min.css">
	<link rel="stylesheet" type="text/css" href="css/ftrack-theme-dark-vars.min.css">
	<link rel="stylesheet" type="text/css" href="css/ftrack-theme.min.css">
	<link rel="stylesheet" type="text/css" href="css/material-icons.css">
	<link rel="stylesheet" type="text/css" href="css/normalize.min.css">
	<link rel="stylesheet" type="text/css" href="css/theme-dark.css">
	<link rel="stylesheet" type="text/css" href="css/nice-select.css">
	
	
	
	<!-- <script type="text/javascript" src="js/rive.js"></script> -->
	<script src="https://unpkg.com/@rive-app/canvas@2.20.0"></script>
	<script type="text/javascript" src="js/jquery-3.7.1.slim.min.js"></script>
	<script type="text/javascript" src="js/jquery.nice-select.js"></script>
	
	<script type="text/javascript" src="js/ui.js"></script>
	<script type="text/javascript" src="js/data_handler.js"></script>
	<script type="text/javascript" src="js/endscreen.js"></script>
	<script type="text/javascript" src="js/mousetrap.min.js"></script>
	
	
	
	
</head>
<body>
	<script>
		//RANDOM CHAR GENERATOR
		function randomCode(len = 4) {
			const alphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
			const out = [];
			const buf = new Uint8Array(len);
			crypto.getRandomValues(buf);
			for (let i = 0; i < len; i++) out.push(alphabet[buf[i] % alphabet.length]);
			return out.join('');
		}

		// SYNC: PARSE "NAME (CODE)" OR BEST-EFFORT FALLBACKS
		function chopTeamString(str) {
			const t = String(str ?? '').trim();
			
			// Exact "Name (CODE)"
			const m = t.match(/^(.*?)\s*\(\s*([^)]+)\s*\)$/);
			if (m) return { name: m[1].trim(), code: m[2].trim() };
			
			// Fallback: last (...) pair if formatting is off
			const open = t.lastIndexOf('('), close = t.lastIndexOf(')');
			if (open !== -1 && close > open) {
				return { name: t.slice(0, open).trim(), code: t.slice(open + 1, close).trim() };
			}
			
			// No parentheses present
			return { name: t, code: '' };
		}
		
		// ASYNC: INITIALIZE THE ROW AND SEED INITIAL VALUES FROM TWO RANDOM TEAMS
		window.initMatchupRow = async function initMatchupRow(target, options = {}) {
			const row = (typeof target === 'string') ? document.querySelector(target) : target;
			if (!row) throw new Error('initMatchupRow: target element not found');
			
			const teams = options.curatedTeams ?? window.curated_teams ?? [];
			if (teams.length < 2) throw new Error('initMatchupRow: need at least 2 curated teams');
			
			const [awayStr, homeStr] = twoRandomDistinct(teams);
			const tempawayparsed = chopTeamString(awayStr);
			const temphomeparsed = chopTeamString(homeStr);
			
			const {
				specialsData    = (window.specials_data ?? null),
				structureData   = (window.structure_data ?? null),
				parseTeamString = async (s) => {
					const m = /\b([A-Z]{2,4})\b/.exec(s || '');
					return { code: m?.[1] || '', name: s };
				},
				icons = [
				{ icon: './img/sunny.svg',      state: 'Day'   },
				{ icon: './img/moon_stars.svg', state: 'Night' },
				],
				onChange = (detail) => console.log('Row changed:', detail),
			} = options;
			
			// Provide datasets / hooks
			row.curatedTeams    = teams;
			row.specialsData    = specialsData;
			row.structureData   = structureData;
			row.parseTeamString = parseTeamString;
			row.icons           = icons;
			
			// Listen for updates
			const handler = (e) => onChange?.(e.detail, e);
			row.addEventListener('rowchange', handler);
			
			// Seed initial values
			row.value = {
				awaysearchbar: awayStr,
				homesearchbar: homeStr,
				'tricode-row-away': tempawayparsed.code,
				'school-row-away':  tempawayparsed.name,
				'tricode-row-home': temphomeparsed.code,
				'school-row-home':  temphomeparsed.name,
				'cal-text-input': '',
				icons,
				currentIcon: { index: 0 },
			};
			
			return {
				row,
				get value() { return row.value; },
				set value(v) { row.value = v; },
				destroy() { row.removeEventListener('rowchange', handler); },
			};
		};
		
		
		// ASYNC: ADD NEW ROW AND SEED INITIAL VALUES FROM TWO RANDOM TEAMS
		async function addMatchupRow(target, options = {}) {
			const row = (typeof target === 'string') ? document.querySelector(target) : target;
			if (!row) throw new Error('initMatchupRow: target element not found');
			
			const teams = options.curatedTeams ?? window.curated_teams ?? [];
			if (teams.length < 2) throw new Error('initMatchupRow: need at least 2 curated teams');
			
			const [awayStr, homeStr] = twoRandomDistinct(teams);
			const tempawayparsed = chopTeamString(awayStr);
			const temphomeparsed = chopTeamString(homeStr);
			
			const {
				specialsData    = (window.specials_data ?? null),
				structureData   = (window.structure_data ?? null),
				parseTeamString = async (s) => {
					const m = /\b([A-Z]{2,4})\b/.exec(s || '');
					return { code: m?.[1] || '', name: s };
				},
				icons = [
				{ icon: './img/sunny.svg',      state: 'Day'   },
				{ icon: './img/moon_stars.svg', state: 'Night' },
				],
				onChange = (detail) => console.log('Row changed:', detail),
			} = options;
			
			// Provide datasets / hooks
			row.curatedTeams    = teams;
			row.specialsData    = specialsData;
			row.structureData   = structureData;
			row.parseTeamString = parseTeamString;
			row.icons           = icons;
			
			// Listen for updates
			const handler = (e) => onChange?.(e.detail, e);
			row.addEventListener('rowchange', handler);
			
			// Seed initial values
			row.value = {
				awaysearchbar: awayStr,
				homesearchbar: homeStr,
				'tricode-row-away': tempawayparsed.code,
				'school-row-away':  tempawayparsed.name,
				'tricode-row-home': temphomeparsed.code,
				'school-row-home':  temphomeparsed.name,
				'cal-text-input': '',
				icons,
				currentIcon: { index: 0 },
			};
			
			return {
				row,
				get value() { return row.value; },
				set value(v) { row.value = v; },
				destroy() { row.removeEventListener('rowchange', handler); },
			};
		};
		
		//MOUNT INITIAL ROW
		function mountRow1(targetSelector = '#rowcollection') {
			return (async () => {
				// ensure the custom element class is registered
				await customElements.whenDefined('matchup-row');
				
				const host = document.querySelector(targetSelector) || document.body;
				const row  = document.createElement('matchup-row');
				const rowprefix = "row_";
				const rowsuffix = randomCode();
				row.id = rowprefix + rowsuffix;
				host.appendChild(row);
				
				// give the microtask queue a tick so connectedCallback runs
				await Promise.resolve();
				
				return row; // <-- resolve with the element
			})();
		}
		
		//MOUNT NEW ROW
		function mountNewRow(targetSelector = '#rowcollection') {
			return (async () => {
				// ensure the custom element class is registered
				// await customElements.whenDefined('matchup-row');
				
				const host = document.querySelector(targetSelector) || document.body;
				const row  = document.createElement('matchup-row');
				
				const rowprefix = "row_";
				const rowsuffix = randomCode();
				
				row.id = rowprefix + rowsuffix;
				host.appendChild(row);
				
				// give the microtask queue a tick so connectedCallback runs
				await Promise.resolve();
				
				return row; // <-- resolve with the element
			})();
		}

		

		
		//NEW ROW SEQUENCE
		async function createNewRow() {
			
			const rowProm = mountNewRow('#rowcollection');
			
			const [row] = await Promise.all([rowProm]);
			row.curatedTeams = window.curated_teams;
			
			row.addEventListener('cornerclick', () => {
				// open menu / run action
				row.remove();
			});
			
			const api = await addMatchupRow(row, {
				curatedTeams: window.curated_teams || [],
				onChange(detail) {
					console.log('rowchange:', detail);
				},
				// initialValue, icons, parseTeamString, etc. can be passed here too
			});
			
			
			
		}
		
		//WAITING FOR TEAMS DATA TO LOAD
		function waitForCuratedTeams() {
			return new Promise((resolve) => {
				if (Array.isArray(window.curated_teams) && window.curated_teams.length) {
					resolve(window.curated_teams);
					return;
				}
				window.addEventListener(
				'curatedTeams:ready',
				(e) => resolve(e.detail?.curated_teams ?? []),
				{ once: true }
				);
			});
		}
		
		// LISTENING FOR TEAMS DATA EVENT DISPATCH
		document.addEventListener('DOMContentLoaded', async () => {
			
			const rowP   = mountRow1('#rowcollection');
			const teamsP = waitForCuratedTeams();
			
			const [row, teams] = await Promise.all([rowP, teamsP]);
			
			row.curatedTeams = teams;
			
			row.addEventListener('cornerclick', () => {
				// open menu / run action
				row.remove();				
			});
			
			
			const api = window.initMatchupRow(row, {
				curatedTeams: teams || [],
				onChange(detail) {
					console.log('rowchange:', detail);
				},
				// initialValue, icons, parseTeamString, etc. can be passed here too
			});
			
			const onCuratedReady = (e) => {
				const teamsx = e.detail?.curated_teams ?? window.curated_teams ?? [];
				console.log('ready teams:', teamsx);
				// TODO: hydrate UI with teams
				// const api = window.initMatchupRow('#row1', { curatedTeams: window.curated_teams });
				
				
			};
			
			const onSpecialsReady = (e) => {
				const specials = e.detail?.specials_data ?? window.specials_data ?? [];
				console.log('ready specials:', specials);
				// TODO: hydrate UI with teams
			};
			
			const onStructureReady = (e) => {
				const struct = e.detail?.structure_data ?? window.structure_data ?? [];
				console.log('ready structure:', struct);
				// TODO: hydrate UI with teams
			};
			
			// HANDLE FUTURE DISPATCHES
			// TEAMS DATA
			window.addEventListener('curatedTeams:ready', onCuratedReady, { once: true });
			
			//SPECIALS DATA
			window.addEventListener('specialsData:ready', onSpecialsReady, { once: true });
			
			//STRUCTURE DATA
			window.addEventListener('structureData:ready', onStructureReady, { once: true });
			
			
			// HANDLE THE CASE WHERE THE EVENT FIRED BEFORE THIS LISTENER WAS ATTACHED
			//FOR TEAMS DATA
			if (Array.isArray(window.curated_teams) && window.curated_teams.length) {
				onCuratedReady({ detail: { curated_teams: window.curated_teams } });
			}
			
			//FOR SPECIALS DATA
			if (Array.isArray(window.specials_data) && window.specials_data.length) {
				onSpecialsReady({ detail: { specials_data: window.specials_data } });
			}
			
			//FOR STRUCTURE DATA
			if (Array.isArray(window.structure_data) && window.structure_data.length) {
				onSpecialsReady({ detail: { structure_data: window.structure_data } });
			}
			
			
		});
		
		//ADMIN PROJECT WITH THUMBNAIL RESOURCES
		var ADMIN_PRJ_ID = "249a98cd-b296-46cd-b6e2-0c9c61608b6c";
		var RESOURCE_FOLDER_ID = "14ede329-6b72-43e1-b458-6ff31196c089";
		var PRJ_ID = '';
		var SELECTED_ENTITY = '';
	</script>
	
	<div id="widget">
		<div class="master-container" id="mastercontainer">
			<div class="main-container" id="maincontainer">
				
				<!-- HEADER WIDGET WORDMARK IMAGE -->
				<div class="header-container">
					<div class="header-image"><img src="./img/matchmaker_wordmark.svg"></div>
				</div>
				
				<div class="row-collection" id="rowcollection">
					
				</div>
				
				<!-- BUTTON ROW -->
				<div class="button-row-container">
					<div class="add-row-btn" onclick="createNewRow()"></div>
					<div class="submit-button" onclick="shotPreflight(SELECTED_ENTITY, SELECTED_ENTITY)">Make Matches</div>
				</div>
			</div>
			
			
		</div>
		
		
	</div>
	
	<script type="text/javascript" src="js/ftrack.min.js"></script>
	<script type="text/javascript" src="js/ftrack_widget.js"></script>
	<script type="text/javascript" src="js/ftrack_data_loader.js"></script>
	<script type="text/javascript" src="js/createassets.js"></script>
	<!-- MATCHUP CUSTOM ELEMENT -->
	<script type="module" src="ui/matchup-row.js"></script>
	
	
</body>
</html>